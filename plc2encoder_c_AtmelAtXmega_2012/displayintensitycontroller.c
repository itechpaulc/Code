





//
//
//
//  Author :    Paul Calinawan
//
//  Date:       Jan 14 , 2012
//
//  Copyrights: Imaging Technologies Inc.
//
//  Product:    ITECH PLC2
//  
//  Subsystem:  Absolute Encoder Monitor Board
//
//  -------------------------------------------
//
//
//      CONFIDENTIAL DOCUMENT
//
//      Property of Imaging Technologies Inc.
//
//




////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////

#include "itechsys.h"


////////////////////////////////////////////////////////////////////


#include "kernel.h"


////////////////////////////////////////////////////////////////////


#include <avr/io.h>

#include <stdlib.h>


#include "displayintensitycontroller.h"


////////////////////////////////////////////////////////////////////
//
//  Local StateMachine Variables
//
////////////////////////////////////////////////////////////////////

U8	intensityData;

///////////////////////////////////////////////////////////////////
//
// Function prototypes
//
////////////////////////////////////////////////////////////////////

void		SetDisplayIntensity(U8 intensityLevel)
{
	int i;
	
	// Invert data treatment
	
	i = intensityLevel - 8;
	
	intensityLevel = abs(i);
	
	intensityData = 0xFF;
	
	intensityData = (intensityData >> intensityLevel);
}


////////////////////////////////////////////////////////////////////
//
//
////////////////////////////////////////////////////////////////////

//
//

void DisplayLEDOFF(void)
{
	PORTD |= DISPLAY_BLANKING_MASK;
}

void DisplayLEDON(void)
{
	PORTD &= ~(DISPLAY_BLANKING_MASK);
}

////////////////////////////////////////////////////////////////////
//
// Initialize Machine
//
////////////////////////////////////////////////////////////////////

void    Init_DisplayIntensityController(void)
{
		DisplayLEDOFF();	
}

////////////////////////////////////////////////////////////////////
//
// Exit Procedures
//
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
//
// GoActive
//
////////////////////////////////////////////////////////////////////

U8 intensityDataMask;

NEW_STATE   DIC_exitA(void)
{
		SetDisplayIntensity(DISPLAY_LOW_INTENSITY);
	
		StartTimer(DISPLAY_INTENSITY_REFRESH_RATE);
		
		intensityDataMask = 0x01;
		
		DisplayLEDOFF();

    return DIC_ACTIVE;
}


////////////////////////////////////////////////////////////////////
//
// TimeOut while in DIC_ACTIVE
//
////////////////////////////////////////////////////////////////////

NEW_STATE   DIC_exitB(void)
{
		StartTimer(DISPLAY_INTENSITY_REFRESH_RATE);
		
		if(intensityData & intensityDataMask)
		{
			DisplayLEDON();
		}
		else
		{
			DisplayLEDOFF();			
		}
		
		intensityDataMask = (intensityDataMask << 1);
		
		if(intensityDataMask == 0)
			intensityDataMask = 0x01;
				
    return SAME_STATE;
}



////////////////////////////////////////////////////////////////////
//
// State Matrix Tables
//
////////////////////////////////////////////////////////////////////

STATE_TRANSITION_MATRIX(_DIC_IDLE)
EV_HANDLER(GoActive, DIC_exitA)
STATE_TRANSITION_MATRIX_END;

STATE_TRANSITION_MATRIX(_DIC_ACTIVE)
EV_HANDLER(TimeOut, DIC_exitB)
STATE_TRANSITION_MATRIX_END;

// 
// VERY IMPORTANT : 
//      State Entry definition order MUST match the 
//      order of the state definition in the .H File 
//
//
//      This the State Machine Response Entry
//

SM_RESPONSE_ENTRY(DIC_Main_Entry)
	STATE(_DIC_IDLE)				,
	STATE(_DIC_ACTIVE)		   
SM_RESPONSE_END


////////////////////////////////////////////////////////////////////
//
// Utility functions
//
////////////////////////////////////////////////////////////////////


