





//
//
//
//  Author :    Paul Calinawan
//
//  Date:       Jan 14 , 2012
//
//  Copyrights: Imaging Technologies Inc.
//
//  Product:    ITECH PLC2
//  
//  Subsystem:  Absolute Encoder Monitor Board
//
//  -------------------------------------------
//
//
//      CONFIDENTIAL DOCUMENT
//
//      Property of Imaging Technologies Inc.
//
//




////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////

#include "itechsys.h"


////////////////////////////////////////////////////////////////////


#include "kernel.h"


////////////////////////////////////////////////////////////////////


#include <avr/io.h>

#include "heartbeat.h"


////////////////////////////////////////////////////////////////////
//
//  Local StateMachine Variables
//
////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////
//
// Function prototypes
//
////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////
//
//
////////////////////////////////////////////////////////////////////

//
//

void HeartBeatON(void)
{
	PORTC |= HEARTBEAT_LED_MASK;
}

void HeartBeatOFF(void)
{
	PORTC &= (~HEARTBEAT_LED_MASK);
}

////////////////////////////////////////////////////////////////////
//
// Initialize Machine
//
////////////////////////////////////////////////////////////////////

void    Init_HeartBeatHandler(void)
{
		HeartBeatOFF();	
}

////////////////////////////////////////////////////////////////////
//
// Exit Procedures
//
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
//
// GoActive
//
////////////////////////////////////////////////////////////////////

NEW_STATE   HBH_exitA(void)
{
		HeartBeatOFF();

		StartTimer(HEARTBEAT_UPDATE_PAUSE);

    return HBH_ACTIVE_PAUSE;
}


////////////////////////////////////////////////////////////////////
//
// TimeOut while in HBH_ACTIVE_PAUSE
//
////////////////////////////////////////////////////////////////////

NEW_STATE   HBH_exitB(void)
{
		HeartBeatON();

		StartTimer(HEARTBEAT_UPDATE_UP);

    return HBH_ACTIVE_UP_1;
}

////////////////////////////////////////////////////////////////////
//
// TimeOut while in HBH_ACTIVE_UP_1
//
////////////////////////////////////////////////////////////////////

NEW_STATE   HBH_exitC(void)
{
		HeartBeatOFF();
		
		StartTimer(HEARTBEAT_UPDATE_DOWN);

    return HBH_ACTIVE_DOWN_1;
}


////////////////////////////////////////////////////////////////////
//
// TimeOut while in HBH_ACTIVE_DOWN_1
//
////////////////////////////////////////////////////////////////////

NEW_STATE   HBH_exitD(void)
{
		HeartBeatON();

		StartTimer(HEARTBEAT_UPDATE_UP);

    return HBH_ACTIVE_UP_2;
}


////////////////////////////////////////////////////////////////////
//
// TimeOut while in HBH_ACTIVE_UP_2
//
////////////////////////////////////////////////////////////////////

NEW_STATE   HBH_exitE(void)
{
		HeartBeatOFF();

		StartTimer(HEARTBEAT_UPDATE_PAUSE);

    return HBH_ACTIVE_PAUSE;
}


////////////////////////////////////////////////////////////////////
//
// State Matrix Tables
//
////////////////////////////////////////////////////////////////////

STATE_TRANSITION_MATRIX(_HBH_IDLE)
EV_HANDLER(GoActive, HBH_exitA)
STATE_TRANSITION_MATRIX_END;

STATE_TRANSITION_MATRIX(_HBH_ACTIVE_PAUSE)
EV_HANDLER(TimeOut, HBH_exitB)
STATE_TRANSITION_MATRIX_END;

STATE_TRANSITION_MATRIX(_HBH_ACTIVE_UP_1)
EV_HANDLER(TimeOut, HBH_exitC)
STATE_TRANSITION_MATRIX_END;

STATE_TRANSITION_MATRIX(_HBH_ACTIVE_DOWN_1)
EV_HANDLER(TimeOut, HBH_exitD)
STATE_TRANSITION_MATRIX_END;

STATE_TRANSITION_MATRIX(_HBH_ACTIVE_UP_2)
EV_HANDLER(TimeOut, HBH_exitE)
STATE_TRANSITION_MATRIX_END;

// 
// VERY IMPORTANT : 
//      State Entry definition order MUST match the 
//      order of the state definition in the .H File 
//
//
//      This the State Machine Response Entry
//

SM_RESPONSE_ENTRY(HBH_Main_Entry)
	STATE(_HBH_IDLE)						,
	STATE(_HBH_ACTIVE_PAUSE)      ,   
	STATE(_HBH_ACTIVE_UP_1)			,
	STATE(_HBH_ACTIVE_DOWN_1)	,
	STATE(_HBH_ACTIVE_UP_2)	,	 
SM_RESPONSE_END


////////////////////////////////////////////////////////////////////
//
// Utility functions
//
////////////////////////////////////////////////////////////////////


